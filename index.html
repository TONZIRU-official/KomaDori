<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Pro (YMM4é¢¨ç·¨é›†æ©Ÿèƒ½ä»˜)</title>
    <style>
        :root { --primary: #1e90ff; --accent: #ff4757; --bg: #f5f6fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ãƒ­ãƒƒã‚¯ç”»é¢ */
        #lock-screen {
            position: fixed; inset: 0; background: #eee; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: #2f3542; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mode-tab { display: flex; gap: 5px; }
        .mode-tab button { background: #57606f; color: white; border: none; padding: 8px 20px; cursor: pointer; border-radius: 4px; }
        .mode-tab button.active { background: var(--primary); }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; display: none; }
        .workspace { display: flex; flex: 1; padding: 10px; gap: 10px; overflow: hidden; }

        /* ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .monitor-section { flex: 2; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; position: relative; }
        video, #preview-canvas { max-width: 100%; max-height: 80%; border: 1px solid #444; }
        
        /* ç·¨é›†ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar { flex: 1; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-y: auto; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-section { height: 180px; background: white; border-top: 2px solid #ddd; padding: 10px; overflow-x: auto; position: relative; }
        .timeline-track { background: #f1f2f6; height: 40px; border-radius: 4px; position: relative; margin-top: 10px; border: 1px solid #ccc; width: 2000px; }
        .text-item { position: absolute; height: 100%; background: rgba(30, 144, 255, 0.6); color: white; font-size: 12px; padding: 2px; border: 1px solid blue; cursor: pointer; border-radius: 3px; white-space: nowrap; overflow: hidden; }
        .playhead { position: absolute; top: 0; width: 2px; height: 100%; background: red; z-index: 10; pointer-events: none; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--accent); color: white; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-gray { background: #747d8c; color: white; }
        
        input[type="text"], input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2>ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
    <input type="password" id="pass-input" style="font-size: 20px; padding: 10px;">
    <button onclick="checkPass()" class="btn btn-blue" style="margin-top:10px;">å…¥å®¤</button>
</div>

<header>
    <div>ğŸ¥ ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Pro</div>
    <div class="mode-tab">
        <button id="btn-shoot-mode" class="active" onclick="switchMode('shoot')">1. æ’®å½±ãƒ¢ãƒ¼ãƒ‰</button>
        <button id="btn-edit-mode" onclick="switchMode('edit')">2. ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ (YMM4é¢¨)</button>
    </div>
    <button id="export-btn" class="btn btn-red" onclick="exportVideo()">ğŸ¬ å®Œæˆãƒ»ä¿å­˜</button>
</header>

<div id="main-content">
    <div class="workspace">
        <div class="monitor-section">
            <video id="video" autoplay playsinline></video>
            <canvas id="preview-canvas" style="display:none;"></canvas>
            
            <div id="shoot-controls" style="margin-top:10px;">
                <button class="btn btn-red" onclick="takePhoto()">ğŸ“¸ å†™çœŸã‚’æ’®ã‚‹</button>
                <button class="btn btn-gray" onclick="popPhoto()">â†©ï¸ 1ã¤æ¶ˆã™</button>
                <span>æšæ•°: <span id="frame-count">0</span></span>
            </div>
            
            <div id="edit-controls" style="display:none; margin-top:10px;">
                <button class="btn btn-blue" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ/ä¸€æ™‚åœæ­¢</button>
                <button class="btn btn-gray" onclick="addTextItem()">â• å­—å¹•ã‚’è¿½åŠ </button>
            </div>
        </div>

        <div class="sidebar" id="edit-sidebar">
            <h3>ğŸ”¤ å­—å¹•è¨­å®š</h3>
            <div id="item-settings" style="display:none;">
                å†…å®¹: <input type="text" id="edit-text-val" oninput="updateCurrentItem()"><br><br>
                é–‹å§‹(ç§’): <input type="number" id="edit-start" step="0.1" oninput="updateCurrentItem()"><br>
                çµ‚äº†(ç§’): <input type="number" id="edit-end" step="0.1" oninput="updateCurrentItem()"><br><br>
                è‰²: <input type="color" id="edit-color" oninput="updateCurrentItem()"><br>
                ã‚µã‚¤ã‚º: <input type="range" id="edit-size" min="10" max="100" oninput="updateCurrentItem()">
                <hr>
                <button class="btn btn-red" onclick="deleteItem()">ğŸ—‘ï¸ ã“ã®å­—å¹•ã‚’æ¶ˆã™</button>
            </div>
            <p id="no-item-msg">å­—å¹•ã‚’é¸æŠã™ã‚‹ã¨è¨­å®šãŒå‡ºã¾ã™</p>
        </div>
    </div>

    <div class="timeline-section" id="timeline">
        <div style="font-size:12px; color:#666;">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (ç§’)</div>
        <div class="timeline-track" id="track" onclick="seekTimeline(event)">
            <div class="playhead" id="playhead"></div>
            </div>
    </div>
</div>

<script>
    const SECRET_PASSWORD = "QXJ0U3Rvc";
    let frames = [];
    let textItems = []; // {id, text, start, end, x, y, color, size}
    let currentMode = 'shoot';
    let isPlaying = false;
    let currentTime = 0;
    let selectedItemId = null;
    let fps = 10;

    const video = document.getElementById('video');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');
    const playhead = document.getElementById('playhead');

    function checkPass() {
        if (document.getElementById('pass-input').value === SECRET_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('btn-shoot-mode').classList.toggle('active', mode === 'shoot');
        document.getElementById('btn-edit-mode').classList.toggle('active', mode === 'edit');
        document.getElementById('shoot-controls').style.display = (mode === 'shoot') ? 'block' : 'none';
        document.getElementById('edit-controls').style.display = (mode === 'edit') ? 'block' : 'none';
        document.getElementById('video').style.display = (mode === 'shoot') ? 'block' : 'none';
        document.getElementById('preview-canvas').style.display = (mode === 'edit') ? 'block' : 'none';
        if(mode === 'edit') {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            renderPreview();
        }
    }

    function takePhoto() {
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        frames.push(c.toDataURL('image/png'));
        document.getElementById('frame-count').innerText = frames.length;
    }

    function popPhoto() { frames.pop(); document.getElementById('frame-count').innerText = frames.length; }

    // ç·¨é›†ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
    function addTextItem() {
        const id = Date.now();
        textItems.push({ id, text: "æ–°ã—ã„å­—å¹•", start: currentTime, end: currentTime + 2, color: "#ffffff", size: 40 });
        refreshTimeline();
        selectItem(id);
    }

    function refreshTimeline() {
        const track = document.getElementById('track');
        // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ˜ãƒƒãƒ‰ä»¥å¤–ï¼‰
        Array.from(track.getElementsByClassName('text-item')).forEach(el => el.remove());
        
        textItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'text-item';
            el.innerText = item.text;
            el.style.left = (item.start * 100) + 'px';
            el.style.width = ((item.end - item.start) * 100) + 'px';
            el.onclick = (e) => { e.stopPropagation(); selectItem(item.id); };
            track.appendChild(el);
        });
    }

    function selectItem(id) {
        selectedItemId = id;
        const item = textItems.find(i => i.id === id);
        document.getElementById('item-settings').style.display = 'block';
        document.getElementById('no-item-msg').style.display = 'none';
        document.getElementById('edit-text-val').value = item.text;
        document.getElementById('edit-start').value = item.start;
        document.getElementById('edit-end').value = item.end;
        document.getElementById('edit-color').value = item.color;
        document.getElementById('edit-size').value = item.size;
    }

    function updateCurrentItem() {
        const item = textItems.find(i => i.id === selectedItemId);
        if(!item) return;
        item.text = document.getElementById('edit-text-val').value;
        item.start = parseFloat(document.getElementById('edit-start').value);
        item.end = parseFloat(document.getElementById('edit-end').value);
        item.color = document.getElementById('edit-color').value;
        item.size = parseInt(document.getElementById('edit-size').value);
        refreshTimeline();
        renderPreview();
    }

    function deleteItem() {
        textItems = textItems.filter(i => i.id !== selectedItemId);
        document.getElementById('item-settings').style.display = 'none';
        document.getElementById('no-item-msg').style.display = 'block';
        refreshTimeline();
        renderPreview();
    }

    function seekTimeline(e) {
        const rect = document.getElementById('track').getBoundingClientRect();
        currentTime = (e.clientX - rect.left) / 100;
        if(currentTime < 0) currentTime = 0;
        updatePlayhead();
        renderPreview();
    }

    function updatePlayhead() {
        playhead.style.left = (currentTime * 100) + 'px';
    }

    function togglePlay() {
        isPlaying = !isPlaying;
        if(isPlaying) requestAnimationFrame(playLoop);
    }

    function playLoop() {
        if(!isPlaying) return;
        currentTime += 1/fps;
        if(currentTime > frames.length / fps) currentTime = 0;
        updatePlayhead();
        renderPreview();
        setTimeout(() => requestAnimationFrame(playLoop), 1000/fps);
    }

    function renderPreview() {
        if(frames.length === 0) return;
        const frameIdx = Math.floor(currentTime * fps);
        const img = new Image();
        img.src = frames[Math.min(frameIdx, frames.length - 1)];
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
            // å­—å¹•åˆæˆ
            textItems.forEach(item => {
                if(currentTime >= item.start && currentTime <= item.end) {
                    ctx.fillStyle = item.color;
                    ctx.font = `bold ${item.size}px sans-serif`;
                    ctx.textAlign = "center";
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 4;
                    ctx.strokeText(item.text, canvas.width/2, canvas.height - 50);
                    ctx.fillText(item.text, canvas.width/2, canvas.height - 50);
                }
            });
        };
    }

    async function exportVideo() {
        if (frames.length === 0) return alert("å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“");
        alert("å‹•ç”»ã‚’åˆæˆã—ã¦æ›¸ãå‡ºã—ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...");
        
        const stream = canvas.captureStream(fps);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'school-movie-ymm.webm'; a.click();
        };

        recorder.start();
        let oldTime = currentTime;
        currentTime = 0;
        for(let i=0; i<frames.length; i++) {
            currentTime = i / fps;
            renderPreview();
            await new Promise(r => setTimeout(r, 1000/fps));
        }
        recorder.stop();
        currentTime = oldTime;
    }
</script>
</body>
</html>
