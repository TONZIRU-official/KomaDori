<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Ultra Pro</title>
    <style>
        :root { --primary: #00a8ff; --accent: #e84118; --dark: #1e2124; --panel: #2f3640; --track: #353b48; }
        body { font-family: sans-serif; background: var(--dark); color: white; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ç”»é¢ */
        #lock-screen { position: fixed; inset: 0; background: #111; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .lock-box { background: #222; padding: 40px; border-radius: 15px; border: 2px solid var(--primary); text-align: center; }
        #pass-input { font-size: 24px; padding: 10px; width: 200px; margin: 20px 0; border-radius: 5px; border: none; text-align: center; }

        /* ãƒ¡ã‚¤ãƒ³UI */
        #app-container { display: none; flex-direction: column; height: 100vh; }
        header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .preview-section { flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        .properties-panel { flex: 1.2; background: var(--panel); padding: 15px; overflow-y: auto; border-left: 2px solid #000; font-size: 13px; }
        
        .canvas-wrapper { position: relative; background: #000; width: 640px; height: 480px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas, video { position: absolute; top: 0; left: 0; width: 640px; height: 480px; object-fit: contain; }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-container { height: 200px; background: #111; border-top: 3px solid #000; display: flex; flex-direction: column; }
        .timeline-scroll { flex: 1; overflow-x: auto; position: relative; padding: 10px 0; cursor: crosshair; }
        .timeline-row { height: 40px; background: var(--track); margin: 5px 0; position: relative; min-width: 5000px; }
        .item-block { position: absolute; height: 30px; top: 5px; background: var(--primary); border: 1px solid #fff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; padding: 0 8px; font-size: 11px; z-index: 2; }
        .playhead { position: absolute; top: 0; width: 2px; height: 100%; background: #fbc531; z-index: 100; pointer-events: none; }

        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-capture { background: var(--accent); color: white; }
        .btn-tool { background: #444; color: white; }
        .active-tab { border-bottom: 3px solid var(--primary); border-radius: 0; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2>ğŸ”‘ STOPMOTION PRO</h2>
        <input type="password" id="pass-input" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">
        <button class="btn btn-tool" style="width:100%" onclick="checkPass()">å…¥å®¤</button>
    </div>
</div>

<div id="app-container">
    <header>
        <div style="font-weight: bold;">ğŸ¬ STOPMOTION ULTRA PRO</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-tool" id="tab-shoot" onclick="setMode('shoot')">ğŸ“· æ’®å½±ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="btn btn-tool" id="tab-edit" onclick="setMode('edit')">âœ‚ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="btn btn-capture" onclick="exportVideo()">ğŸ¬ æ›¸ãå‡ºã—</button>
        </div>
    </header>

    <div class="main-layout">
        <section class="preview-section">
            <div class="canvas-wrapper">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="onion-layer" style="opacity: 0.4; pointer-events: none;"></canvas>
                <canvas id="main-canvas"></canvas>
            </div>
            <div style="margin-top:15px; display:flex; gap:20px; align-items:center;">
                <button class="btn btn-capture" id="shutter-btn" onclick="takePhoto()" style="font-size:1.2em;">ğŸ“¸ æ’®å½± (Enter)</button>
                <button class="btn btn-tool" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ/åœæ­¢</button>
                <span>æšæ•°: <b id="frame-count">0</b></span>
                <span>é€Ÿåº¦: <input type="number" id="fps-input" value="10" style="width:40px; background:#000; color:#fff;" oninput="fps=this.value"> fps</span>
            </div>
        </section>

        <aside class="properties-panel">
            <div id="no-selection">ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã‹ã€é’ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div id="editor-ui" style="display:none;">
                <h3 style="color:var(--primary)">ã‚¢ã‚¤ãƒ†ãƒ ç·¨é›†</h3>
                ãƒ†ã‚­ã‚¹ãƒˆ/çµµæ–‡å­—: <input type="text" id="prop-text" oninput="updateItem()" style="width:100%; margin-bottom:10px;">
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <button onclick="addShape('â­')">â­</button><button onclick="addShape('ğŸ’¬')">ğŸ’¬</button><button onclick="addShape('â¤ï¸')">â¤ï¸</button><button onclick="addShape('ğŸ”¥')">ğŸ”¥</button>
                </div>
                è‰²: <input type="color" id="prop-color" oninput="updateItem()"><br>
                ç¸: <input type="color" id="prop-stroke" oninput="updateItem()" value="#000000"><br>
                ã‚µã‚¤ã‚º: <input type="range" id="prop-size" min="10" max="250" oninput="updateItem()"><br>
                ä¸é€æ˜åº¦: <input type="range" id="prop-alpha" min="0" max="100" oninput="updateItem()"><br>
                æ¨ªä½ç½®: <input type="range" id="prop-x" min="0" max="640" oninput="updateItem()"><br>
                ç¸¦ä½ç½®: <input type="range" id="prop-y" min="0" max="480" oninput="updateItem()"><br>
                <label><input type="checkbox" id="prop-fade" onchange="updateItem()"> ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ</label><br><br>
                <button class="btn btn-capture" onclick="deleteItem()" style="width:100%">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
            <button class="btn btn-tool" style="width:100%; margin-top:20px;" onclick="addItem()">â• æ–°ã—ã„å­—å¹•ã‚’è¿½åŠ </button>
        </aside>
    </div>

    <div class="timeline-container">
        <div class="timeline-scroll" id="tl-scroll" onclick="seek(event)">
            <div class="playhead" id="playhead"></div>
            <div class="timeline-row" id="track-1"></div>
        </div>
    </div>
</div>

<script>
    const SECRET_PASSWORD = "ArtStop"; 
    let frames = [], items = [], mode = 'shoot', curTime = 0, isPlaying = false, selectedId = null, fps = 10;
    const pxPerSec = 100;

    const video = document.getElementById('video'), mainCanvas = document.getElementById('main-canvas'), mCtx = mainCanvas.getContext('2d'), onionCanvas = document.getElementById('onion-layer'), oCtx = onionCanvas.getContext('2d');

    function checkPass() {
        if (document.getElementById('pass-input').value === SECRET_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            initApp();
        }
    }

    async function initApp() {
        const stream = await navigator.mediaDevices.getUserMedia({video: {width: 640, height: 480}});
        video.srcObject = stream;
        mainCanvas.width = onionCanvas.width = 640;
        mainCanvas.height = onionCanvas.height = 480;
        setMode('shoot');
    }

    function setMode(m) {
        mode = m;
        document.getElementById('tab-shoot').classList.toggle('active-tab', m==='shoot');
        document.getElementById('tab-edit').classList.toggle('active-tab', m==='edit');
        video.style.display = m==='shoot' ? 'block' : 'none';
        onionCanvas.style.display = m==='shoot' ? 'block' : 'none';
        draw();
    }

    function takePhoto() {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 640; tempCanvas.height = 480;
        tempCanvas.getContext('2d').drawImage(video, 0, 0);
        const url = tempCanvas.toDataURL('image/png');
        frames.push(url);
        document.getElementById('frame-count').innerText = frames.length;

        // ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³æ›´æ–°
        const img = new Image();
        img.onload = () => { oCtx.clearRect(0,0,640,480); oCtx.drawImage(img, 0, 0); };
        img.src = url;
    }

    function addItem() {
        const id = Date.now();
        items.push({ id, text: "ãƒ†ã‚­ã‚¹ãƒˆ", start: curTime, end: curTime+2, x: 320, y: 400, color: "#ffffff", stroke: "#000000", size: 40, alpha: 1, fade: false });
        renderTimeline(); selectItem(id); setMode('edit');
    }

    function addShape(emoji) { if(selectedId) { const item = items.find(i=>i.id===selectedId); item.text = emoji; updateItem(); } }

    function renderTimeline() {
        const track = document.getElementById('track-1');
        track.innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-block';
            div.innerText = item.text;
            div.style.left = (item.start * pxPerSec) + 'px';
            div.style.width = ((item.end - item.start) * pxPerSec) + 'px';
            div.onclick = (e) => { e.stopPropagation(); selectItem(item.id); };
            track.appendChild(div);
        });
    }

    function selectItem(id) {
        selectedId = id; const item = items.find(i => i.id === id);
        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('editor-ui').style.display = 'block';
        document.getElementById('prop-text').value = item.text;
        document.getElementById('prop-color').value = item.color;
        document.getElementById('prop-stroke').value = item.stroke;
        document.getElementById('prop-size').value = item.size;
        document.getElementById('prop-alpha').value = item.alpha * 100;
        document.getElementById('prop-x').value = item.x;
        document.getElementById('prop-y').value = item.y;
        document.getElementById('prop-fade').checked = item.fade;
    }

    function updateItem() {
        const item = items.find(i => i.id === selectedId);
        if(!item) return;
        item.text = document.getElementById('prop-text').value;
        item.color = document.getElementById('prop-color').value;
        item.stroke = document.getElementById('prop-stroke').value;
        item.size = parseInt(document.getElementById('prop-size').value);
        item.alpha = document.getElementById('prop-alpha').value / 100;
        item.x = parseInt(document.getElementById('prop-x').value);
        item.y = parseInt(document.getElementById('prop-y').value);
        item.fade = document.getElementById('prop-fade').checked;
        renderTimeline(); draw();
    }

    // --- ã‚³ã‚¢æç”»ã‚¨ãƒ³ã‚¸ãƒ³ ---
    async function draw() {
        if(frames.length === 0) { mCtx.clearRect(0,0,640,480); return; }
        const idx = Math.min(Math.floor(curTime * fps), frames.length - 1);
        
        await new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                mCtx.clearRect(0,0,640,480);
                mCtx.drawImage(img, 0, 0);
                items.forEach(item => {
                    if(curTime >= item.start && curTime <= item.end) {
                        let a = item.alpha;
                        if(item.fade && (item.end - curTime < 0.5)) a *= ((item.end - curTime) / 0.5);
                        mCtx.globalAlpha = Math.max(0, a);
                        mCtx.font = `bold ${item.size}px sans-serif`;
                        mCtx.textAlign = "center";
                        mCtx.lineWidth = item.size / 6;
                        mCtx.strokeStyle = item.stroke;
                        mCtx.strokeText(item.text, item.x, item.y);
                        mCtx.fillStyle = item.color;
                        mCtx.fillText(item.text, item.x, item.y);
                        mCtx.globalAlpha = 1;
                    }
                });
                resolve();
            };
            img.src = frames[idx];
        });
    }

    function seek(e) {
        const rect = document.getElementById('tl-scroll').getBoundingClientRect();
        curTime = (e.clientX - rect.left + document.getElementById('tl-scroll').scrollLeft) / pxPerSec;
        if(curTime < 0) curTime = 0;
        document.getElementById('playhead').style.left = (curTime * pxPerSec) + 'px';
        draw();
    }

    function togglePlay() { isPlaying = !isPlaying; if(isPlaying) loop(); }
    
    async function loop() {
        if(!isPlaying) return;
        curTime += 1/fps;
        if(curTime >= frames.length/fps) { curTime = 0; isPlaying = false; }
        document.getElementById('playhead').style.left = (curTime * pxPerSec) + 'px';
        await draw();
        if(isPlaying) requestAnimationFrame(loop);
    }

    function deleteItem() { items = items.filter(i => i.id !== selectedId); document.getElementById('editor-ui').style.display = 'none'; renderTimeline(); draw(); }
    
    window.onkeydown = e => { if(e.key === 'Enter' && mode === 'shoot') takePhoto(); };

    async function exportVideo() {
        if(frames.length === 0) return;
        isPlaying = false;
        const stream = mainCanvas.captureStream(fps);
        const rec = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp8'});
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            const blob = new Blob(chunks, {type:'video/webm'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'stopmotion_movie.webm'; a.click();
        };

        rec.start();
        for(let i=0; i < frames.length; i++) {
            curTime = i / fps;
            document.getElementById('playhead').style.left = (curTime * pxPerSec) + 'px';
            await draw();
            await new Promise(r => setTimeout(r, 50)); // ã‚­ãƒ£ãƒ—ãƒãƒ£ã®ãŸã‚ã®åƒ…ã‹ãªå¾…ã¡
        }
        rec.stop();
        alert("æ›¸ãå‡ºã—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
    }
</script>
</body>
</html>
