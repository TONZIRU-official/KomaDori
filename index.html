<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆå­¦æ ¡ç”¨ï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #fafafa; margin: 0; }
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f0f0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        #main-content { display: none; padding: 20px; }
        
        .viewer-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        video, canvas { width: 400px; background: #000; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .controls { margin: 20px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; transition: 0.2s; }
        
        #shutter { background: #ff4757; color: white; font-weight: bold; }
        #shutter:hover { background: #ff6b81; }
        #play-btn { background: #2ed573; color: white; }
        #download-btn { background: #1e90ff; color: white; }
        #delete-btn { background: #ffa502; color: white; }

        .frames { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px; overflow-y: auto; max-height: 200px; }
        .frames img { width: 100px; border: 2px solid transparent; }
        .current-frame { border: 2px solid #ff4757 !important; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
        <input type="password" id="pass-input" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">
        <button onclick="checkPass()">å…¥å®¤</button>
        <p id="error-msg" style="color: red;"></p>
    </div>

    <div id="main-content">
        <h1>ğŸ¬ ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
        
        <div class="viewer-container">
            <div>
                <p>ã‚«ãƒ¡ãƒ©ï¼ˆæ’®å½±ï¼‰</p>
                <video id="video" autoplay playsinline></video>
            </div>
            <div>
                <p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå†ç”Ÿï¼‰</p>
                <canvas id="canvas-preview"></canvas>
            </div>
        </div>

        <div class="controls">
            <button id="shutter">ğŸ“¸ å†™çœŸã‚’æ’®ã‚‹</button>
            <button id="delete-btn">â†©ï¸ 1ã¤æ¶ˆã™</button>
            <button id="play-btn">â–¶ï¸ å†ç”Ÿã™ã‚‹</button>
            <button id="download-btn">ğŸ’¾ å‹•ç”»ã‚’ä¿å­˜</button>
            <span>é€Ÿåº¦: <input type="number" id="fps" value="10" min="1" max="30" style="width:40px"> fps</span>
        </div>

        <h3>æ’®å½±ã—ãŸã‚³ãƒï¼ˆåˆè¨ˆ: <span id="count">0</span>æšï¼‰</h3>
        <div id="frames" class="frames"></div>
    </div>

    <script>
        const SECRET_PASSWORD = "QXJ0U3Rvc"; 
        const video = document.getElementById('video');
        const shutter = document.getElementById('shutter');
        const playBtn = document.getElementById('play-btn');
        const downloadBtn = document.getElementById('download-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const framesContainer = document.getElementById('frames');
        const canvasPreview = document.getElementById('canvas-preview');
        const ctx = canvasPreview.getContext('2d');
        const countDisplay = document.getElementById('count');

        let capturedFrames = [];

        function checkPass() {
            if (document.getElementById('pass-input').value === SECRET_PASSWORD) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                startCamera();
            } else {
                document.getElementById('error-msg').innerText = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
            }
        }

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvasPreview.width = video.videoWidth;
                canvasPreview.height = video.videoHeight;
            };
        }

        // æ’®å½±
        shutter.onclick = () => {
            const c = document.createElement('canvas');
            c.width = video.videoWidth;
            c.height = video.videoHeight;
            c.getContext('2d').drawImage(video, 0, 0);
            const imgUrl = c.toDataURL('image/png');
            capturedFrames.push(imgUrl);
            updateFrames();
        };

        // 1ã¤å‰Šé™¤
        deleteBtn.onclick = () => {
            capturedFrames.pop();
            updateFrames();
        };

        function updateFrames() {
            framesContainer.innerHTML = '';
            capturedFrames.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                framesContainer.appendChild(img);
            });
            countDisplay.innerText = capturedFrames.length;
        }

        // å†ç”Ÿ
        playBtn.onclick = () => {
            if (capturedFrames.length === 0) return;
            let i = 0;
            const fps = document.getElementById('fps').value;
            const interval = setInterval(() => {
                const img = new Image();
                img.src = capturedFrames[i];
                img.onload = () => ctx.drawImage(img, 0, 0);
                i++;
                if (i >= capturedFrames.length) clearInterval(interval);
            }, 1000 / fps);
        };

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (WebMå½¢å¼)
        downloadBtn.onclick = () => {
            if (capturedFrames.length === 0) return;
            const fps = document.getElementById('fps').value;
            const stream = canvasPreview.captureStream(fps);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'koma-movie.webm';
                a.click();
            };

            recorder.start();
            let i = 0;
            const interval = setInterval(() => {
                const img = new Image();
                img.src = capturedFrames[i];
                img.onload = () => ctx.drawImage(img, 0, 0);
                i++;
                if (i >= capturedFrames.length) {
                    clearInterval(interval);
                    setTimeout(() => recorder.stop(), 500);
                }
            }, 1000 / fps);
        };
    </script>
</body>
</html>
