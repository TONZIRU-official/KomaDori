<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Pro (ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ï¼†ç·¨é›†)</title>
    <style>
        :root { --primary: #1e90ff; --accent: #ff4757; --bg: #f5f6fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ãƒ­ãƒƒã‚¯ç”»é¢ */
        #lock-screen { position: fixed; inset: 0; background: #eee; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: #2f3542; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mode-tab button { background: #57606f; color: white; border: none; padding: 8px 20px; cursor: pointer; border-radius: 4px; margin-left: 5px; }
        .mode-tab button.active { background: var(--primary); }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; display: none; }
        .workspace { display: flex; flex: 1; padding: 10px; gap: 10px; overflow: hidden; }

        /* æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        .shoot-area { flex: 2; position: relative; background: #000; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .video-container { position: relative; width: 640px; height: 480px; }
        video, #onion-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 4px; }
        #onion-canvas { opacity: 0.5; pointer-events: none; } /* å‰ã®å†™çœŸã‚’é€ã‹ã™ */

        /* æ’®å½±æ¸ˆã¿å†™çœŸãƒªã‚¹ãƒˆ */
        .photo-list { flex: 1; background: white; padding: 10px; border-radius: 8px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start; }
        .photo-list img { width: 80px; height: 60px; object-fit: cover; border: 1px solid #ccc; }

        /* ç·¨é›†ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ (ä»¥å‰ã®æ©Ÿèƒ½ã‚’ç¶­æŒ) */
        #edit-section { display: none; flex: 1; flex-direction: column; }
        .timeline-track { background: #f1f2f6; height: 60px; border-radius: 4px; position: relative; margin: 10px; border: 1px solid #ccc; overflow-x: auto; }
        .playhead { position: absolute; top: 0; width: 2px; height: 100%; background: red; z-index: 10; }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-red { background: var(--accent); color: white; }
        .btn-blue { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h2>ğŸ”‘ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</h2>
    <input type="password" id="pass-input" style="font-size: 20px; padding: 10px;">
    <button onclick="checkPass()" class="btn btn-blue">å…¥å®¤</button>
</div>

<header>
    <div>ğŸ“¸ ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Pro</div>
    <div class="mode-tab">
        <button id="btn-shoot-mode" class="active" onclick="switchMode('shoot')">1. æ’®å½±ï¼ˆã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ï¼‰</button>
        <button id="btn-edit-mode" onclick="switchMode('edit')">2. ç·¨é›†ï¼ˆYMM4é¢¨ï¼‰</button>
    </div>
    <button class="btn btn-red" onclick="exportVideo()">ğŸ¬ å®Œæˆä¿å­˜</button>
</header>

<div id="main-content">
    <div id="shoot-section" class="workspace">
        <div class="shoot-area">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="onion-canvas"></canvas> </div>
            <div style="margin-top:10px;">
                <button class="btn btn-red" id="shutter" onclick="takePhoto()">ğŸ“¸ æ’®å½± (Enter)</button>
                <button class="btn btn-blue" onclick="popPhoto()">â†©ï¸ 1æšæ¶ˆã™</button>
                <span style="color:white;">æšæ•°: <span id="frame-count">0</span></span>
            </div>
        </div>
        <div class="photo-list" id="photo-list">
            </div>
    </div>

    <div id="edit-section" class="workspace">
        <div class="shoot-area">
            <canvas id="preview-canvas" width="640" height="480"></canvas>
            <div style="margin-top:10px;">
                <button class="btn btn-blue" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ/åœæ­¢</button>
                <button class="btn btn-blue" onclick="addTextItem()">â• å­—å¹•ã‚’è¿½åŠ </button>
            </div>
        </div>
        <div class="photo-list" style="flex:0.5; min-width:200px;">
            <h3>å­—å¹•è¨­å®š</h3>
            <div id="item-settings" style="display:none;">
                å†…å®¹: <input type="text" id="edit-text-val" oninput="updateCurrentItem()"><br><br>
                è‰²: <input type="color" id="edit-color" oninput="updateCurrentItem()">
                <button class="btn btn-red" onclick="deleteItem()">ğŸ—‘ï¸ æ¶ˆã™</button>
            </div>
        </div>
    </div>

    <div class="timeline-track" id="track" onclick="seekTimeline(event)">
        <div class="playhead" id="playhead"></div>
    </div>
</div>

<script>
    const SECRET_PASSWORD = "QXJ0U3Rvc";
    let frames = [];
    let textItems = [];
    let currentTime = 0;
    let isPlaying = false;
    let fps = 10;

    const video = document.getElementById('video');
    const onionCanvas = document.getElementById('onion-canvas');
    const oCtx = onionCanvas.getContext('2d');
    const previewCanvas = document.getElementById('preview-canvas');
    const pCtx = previewCanvas.getContext('2d');

    function checkPass() {
        if (document.getElementById('pass-input').value === SECRET_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'flex';
            startCamera();
        }
    }

    async function startCamera() {
        const s = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        video.srcObject = s;
        video.onloadedmetadata = () => {
            onionCanvas.width = previewCanvas.width = video.videoWidth;
            onionCanvas.height = previewCanvas.height = video.videoHeight;
        };
    }

    // æ’®å½±æ©Ÿèƒ½
    function takePhoto() {
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        const data = c.toDataURL('image/png');
        frames.push(data);
        
        // ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ã‚’æ›´æ–°ï¼ˆä»Šã®å†™çœŸã‚’æ¬¡ã®ã‚¬ã‚¤ãƒ‰ã«ã™ã‚‹ï¼‰
        const img = new Image();
        img.src = data;
        img.onload = () => {
            oCtx.clearRect(0,0,onionCanvas.width, onionCanvas.height);
            oCtx.globalAlpha = 0.4; // é€æ˜åº¦
            oCtx.drawImage(img, 0, 0);
        };

        updatePhotoList();
    }

    function popPhoto() {
        frames.pop();
        updatePhotoList();
        // ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ã‚’ä¸€ã¤å‰ã«æˆ»ã™
        oCtx.clearRect(0,0,onionCanvas.width, onionCanvas.height);
        if(frames.length > 0) {
            const img = new Image();
            img.src = frames[frames.length-1];
            img.onload = () => oCtx.drawImage(img, 0, 0);
        }
    }

    function updatePhotoList() {
        const list = document.getElementById('photo-list');
        list.innerHTML = '';
        frames.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            list.appendChild(img);
        });
        document.getElementById('frame-count').innerText = frames.length;
    }

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    function switchMode(mode) {
        document.getElementById('shoot-section').style.display = (mode === 'shoot') ? 'flex' : 'none';
        document.getElementById('edit-section').style.display = (mode === 'edit') ? 'flex' : 'none';
        document.getElementById('btn-shoot-mode').className = (mode === 'shoot') ? 'active' : '';
        document.getElementById('btn-edit-mode').className = (mode === 'edit') ? 'active' : '';
        if(mode === 'edit') renderPreview();
    }

    // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: Enterã§æ’®å½±
    window.addEventListener('keydown', e => {
        if(e.key === 'Enter' && document.getElementById('shoot-section').style.display !== 'none') {
            takePhoto();
        }
    });

    // --- ç·¨é›†ãƒ»å†ç”Ÿãƒ»æ›¸ãå‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“åŒ–ã—ã¦ç¶­æŒ) ---
    function addTextItem() {
        textItems.push({ id: Date.now(), text: "ãƒ†ãƒ­ãƒƒãƒ—", start: currentTime, end: currentTime+2, color: "#ffffff" });
        switchMode('edit');
    }

    function renderPreview() {
        if(frames.length === 0) return;
        const idx = Math.floor(currentTime * fps);
        const img = new Image();
        img.src = frames[Math.min(idx, frames.length - 1)];
        img.onload = () => {
            pCtx.drawImage(img, 0, 0);
            textItems.forEach(item => {
                if(currentTime >= item.start && currentTime <= item.end) {
                    pCtx.fillStyle = item.color;
                    pCtx.font = "40px sans-serif";
                    pCtx.fillText(item.text, 50, 400);
                }
            });
        };
    }
    
    function togglePlay() { isPlaying = !isPlaying; if(isPlaying) play(); }
    function play() {
        if(!isPlaying) return;
        currentTime += 1/fps;
        if(currentTime > frames.length/fps) currentTime = 0;
        document.getElementById('playhead').style.left = (currentTime * 50) + 'px';
        renderPreview();
        setTimeout(play, 1000/fps);
    }

    function seekTimeline(e) {
        const rect = document.getElementById('track').getBoundingClientRect();
        currentTime = (e.clientX - rect.left) / 50;
        document.getElementById('playhead').style.left = (e.clientX - rect.left) + 'px';
        renderPreview();
    }

    async function exportVideo() {
        alert("æ›¸ãå‡ºã—ã‚’é–‹å§‹ã—ã¾ã™...");
        const stream = previewCanvas.captureStream(fps);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(chunks, { type: 'video/webm' }));
            a.download = 'koma-movie.webm'; a.click();
        };
        recorder.start();
        for(let i=0; i<frames.length; i++) {
            currentTime = i/fps;
            renderPreview();
            await new Promise(r => setTimeout(r, 100));
        }
        recorder.stop();
    }
</script>
</body>
</html>
