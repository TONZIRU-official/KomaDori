<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>KOMADORI STUDIO - LIVE COLLAB</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --accent: #ff4757;
            --blue: #00a8ff; --green: #2ed573; --text: #eee; --purple: #a55eea;
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* ãƒ­ãƒƒã‚¯ç”»é¢ */
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .lock-card { background: var(--panel); padding: 40px; border-radius: 12px; border: 1px solid var(--blue); text-align: center; }
        input[type="password"] { font-size: 20px; padding: 10px; border-radius: 6px; border: 1px solid #444; background: #000; color: #fff; width: 200px; text-align: center; margin-bottom: 20px; outline: none; }

        header { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .status { font-weight: bold; color: var(--blue); }
        .conn-status { font-size: 12px; color: #888; margin-left: 10px; }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; position: relative; }
        .monitor-wrapper { position: relative; width: 640px; height: 480px; background: #000; border: 3px solid #333; border-radius: 8px; }
        video, canvas { position: absolute; top: 0; left: 0; width: 640px; height: 480px; }
        #onion-layer { opacity: 0.4; pointer-events: none; }

        .controls { display: flex; gap: 10px; margin-top: 15px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 10px 18px; font-size: 14px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; gap: 5px; }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .btn-shoot { background: var(--accent); font-size: 18px; padding: 15px 30px; }
        .btn-play { background: var(--blue); }
        .btn-download { background: var(--green); }
        .btn-save { background: var(--purple); }
        .btn-load { background: #4b6584; }
        .btn-undo { background: #57606f; }
        .btn-reset { background: #333; border: 1px solid var(--accent); color: var(--accent); }
        /* å…±æœ‰ãƒœã‚¿ãƒ³ç”¨ */
        .btn-share { background: #6c5ce7; border: 1px solid #a29bfe; }

        .gallery { height: 110px; background: #0a0a0a; display: flex; gap: 6px; padding: 8px; overflow-x: auto; border-top: 1px solid #222; }
        .gallery-item { height: 90px; border: 1px solid #444; position: relative; }
        .gallery-item span { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); font-size: 10px; padding: 2px 4px; }
        
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }

        /* å…±æœ‰ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 12px; border: 2px solid var(--purple); width: 400px; text-align: center; }
        .code-display { font-size: 32px; font-family: monospace; color: var(--purple); background: #000; padding: 10px; border-radius: 8px; margin: 20px 0; border: 1px dashed var(--purple); }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-card">
        <h2>ğŸ”‘ PASSCODE</h2>
        <input type="password" id="pass-input" placeholder="****">
        <br>
        <button class="btn btn-play" style="width:100%" onclick="checkPass()">ENTER STUDIO</button>
    </div>
</div>

<div id="overlay">
    <h2 id="overlay-msg">ğŸ¬ å‡¦ç†ä¸­...</h2>
</div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ¤ å…±åŒä½œæ¥­ã‚’é–‹å§‹</h3>
        <p>ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«ä¼ãˆã¦ãã ã•ã„ï¼š</p>
        <div id="my-peer-id" class="code-display">ç™ºè¡Œä¸­...</div>
        <p style="font-size: 12px; color: #888;">ç›¸æ‰‹ãŒæ¥ç¶šã™ã‚‹ã¨ã€å†™çœŸãŒåŒæœŸã•ã‚Œã¾ã™ã€‚</p>
        <button class="btn" style="background:#555; width:100%" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<header>
    <div>
        <span class="status">ğŸ¬ KOMADORI STUDIO</span>
        <span id="conn-info" class="conn-status">â— ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-share" onclick="openShareModal()">ğŸ”— å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</button>
        <button class="btn btn-share" style="background:#4834d4;" onclick="joinRoom()">ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦å‚åŠ </button>
        <button class="btn btn-save" onclick="saveProject()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-load" onclick="document.getElementById('file-input').click()">ğŸ“‚ èª­è¾¼</button>
        <input type="file" id="file-input" style="display:none;" accept=".json" onchange="loadProject(event)">
    </div>
    <div>ã‚³ãƒæ•°: <span id="count" style="font-size: 20px;">0</span></div>
</header>

<div class="container">
    <div class="monitor-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="onion-layer"></canvas> 
        <canvas id="play-canvas" style="display:none;"></canvas>
    </div>

    <div class="controls">
        <button class="btn btn-shoot" onclick="takePhoto(true)">ğŸ“¸ æ’®å½± (Enter)</button>
        <button class="btn btn-play" id="play-btn" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ</button>
        <button class="btn btn-download" onclick="downloadVideo()">ğŸ“¹ å‹•ç”»æ›¸ãå‡ºã—</button>
        <button class="btn btn-undo" onclick="deleteLast(true)">â†©ï¸ 1ã¤æˆ»ã‚‹</button>
        <button class="btn btn-reset" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        <div style="font-size: 12px; color: #888;">é€Ÿåº¦: <input type="number" id="fps" value="10" style="width:40px; background:#000; color:#fff; border:1px solid #444;"> fps</div>
    </div>
</div>

<div class="gallery" id="gallery"></div>

<script>
    const PASS = "ArtStop";
    let frames = [];
    let isPlaying = false;
    let playIdx = 0;

    // é€šä¿¡ç”¨ã®å¤‰æ•°
    let peer = null;
    let conn = null;

    const video = document.getElementById('video');
    const onionCanvas = document.getElementById('onion-layer');
    const oCtx = onionCanvas.getContext('2d');
    const playCanvas = document.getElementById('play-canvas');
    const pCtx = playCanvas.getContext('2d');

    function checkPass() {
        if(document.getElementById('pass-input').value === PASS) {
            document.getElementById('lock-screen').style.display = 'none';
            startCamera();
        }
    }

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({video: {width: 640, height: 480}});
        video.srcObject = stream;
        onionCanvas.width = playCanvas.width = 640;
        onionCanvas.height = playCanvas.height = 480;
    }

    // --- ã€ä¿®æ­£ã€‘æ’®å½±æ©Ÿèƒ½ (sendDataã§åŒæœŸ) ---
    function takePhoto(shouldSync) {
        if(isPlaying) return;
        const c = document.createElement('canvas');
        c.width = 640; c.height = 480;
        c.getContext('2d').drawImage(video, 0, 0);
        const data = c.toDataURL('image/png');
        frames.push(data);
        updateUI();
        updateOnionSkin(data);

        // ç›¸æ‰‹ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
        if(shouldSync && conn && conn.open) {
            conn.send({ type: 'ADD', frame: data });
        }
    }

    // --- ã€ä¿®æ­£ã€‘1ã¤æˆ»ã‚‹ (sendDataã§åŒæœŸ) ---
    function deleteLast(shouldSync) {
        if(frames.length === 0) return;
        frames.pop();
        updateUI();
        if(frames.length > 0) updateOnionSkin(frames[frames.length - 1]);
        else oCtx.clearRect(0, 0, 640, 480);

        if(shouldSync && conn && conn.open) {
            conn.send({ type: 'UNDO' });
        }
    }

    // --- ã€æ–°æ©Ÿèƒ½ã€‘ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒä½œæ¥­ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

    function openShareModal() {
        document.getElementById('share-modal').style.display = 'flex';
        if (!peer) {
            peer = new Peer();
            peer.on('open', (id) => {
                document.getElementById('my-peer-id').innerText = id;
            });
            peer.on('connection', (c) => {
                conn = c;
                initConnection();
            });
        }
    }

    function joinRoom() {
        const targetId = prompt("ç›¸æ‰‹ã®å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (!targetId) return;
        if (!peer) peer = new Peer();
        
        peer.on('open', () => {
            conn = peer.connect(targetId);
            initConnection();
        });
    }

    function initConnection() {
        conn.on('open', () => {
            document.getElementById('conn-info').innerText = "â— æ¥ç¶šæ¸ˆã¿";
            document.getElementById('conn-info').style.color = "var(--green)";
            closeModal();
            // æ¥ç¶šç›´å¾Œã«ã€ä»Šã‚ã‚‹å…¨ã‚³ãƒã‚’é€ã£ã¦åŒæœŸã™ã‚‹
            conn.send({ type: 'SYNC', frames: frames });
        });

        conn.on('data', (data) => {
            if (data.type === 'ADD') {
                frames.push(data.frame);
                updateUI();
                updateOnionSkin(data.frame);
            } else if (data.type === 'UNDO') {
                deleteLast(false);
            } else if (data.type === 'SYNC') {
                frames = data.frames;
                updateUI();
                if(frames.length > 0) updateOnionSkin(frames[frames.length - 1]);
            }
        });
    }

    function closeModal() { document.getElementById('share-modal').style.display = 'none'; }

    // --- æ—¢å­˜ã®ä¾¿åˆ©æ©Ÿèƒ½ï¼ˆã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ç­‰ï¼‰ ---

    function resetAll() {
        if(frames.length === 0) return;
        if(confirm("ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            frames = [];
            oCtx.clearRect(0, 0, 640, 480);
            updateUI();
        }
    }

    function saveProject() {
        if(frames.length === 0) { alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        const data = { fps: document.getElementById('fps').value, frames: frames };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `stopmotion_save.json`;
        a.click();
    }

    function loadProject(event) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        document.getElementById('overlay').style.display = 'flex';
        reader.onload = (e) => {
            const data = JSON.parse(e.target.result);
            frames = data.frames;
            document.getElementById('fps').value = data.fps || 10;
            updateUI();
            if(frames.length > 0) updateOnionSkin(frames[frames.length - 1]);
            document.getElementById('overlay').style.display = 'none';
        };
        reader.readAsText(file);
    }

    function updateOnionSkin(src) {
        const img = new Image();
        img.onload = () => { oCtx.clearRect(0, 0, 640, 480); oCtx.drawImage(img, 0, 0); };
        img.src = src;
    }

    function updateUI() {
        document.getElementById('count').innerText = frames.length;
        const gal = document.getElementById('gallery');
        gal.innerHTML = '';
        frames.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            const img = document.createElement('img');
            img.src = src; img.style.height = "90px";
            const label = document.createElement('span');
            label.innerText = index + 1;
            div.appendChild(img); div.appendChild(label);
            gal.appendChild(div);
        });
        gal.scrollLeft = gal.scrollWidth; 
    }

    function togglePlay() {
        if(frames.length === 0) return;
        isPlaying = !isPlaying;
        const btn = document.getElementById('play-btn');
        if(isPlaying) {
            btn.innerText = "â¹ï¸ åœæ­¢";
            playCanvas.style.display = "block";
            playLoop();
        } else {
            btn.innerText = "â¯ï¸ å†ç”Ÿ";
            playCanvas.style.display = "none";
        }
    }

    function playLoop() {
        if(!isPlaying) return;
        const img = new Image();
        img.onload = () => {
            pCtx.clearRect(0, 0, 640, 480);
            pCtx.drawImage(img, 0, 0);
            playIdx = (playIdx + 1) % frames.length;
            setTimeout(playLoop, 1000 / document.getElementById('fps').value);
        };
        img.src = frames[playIdx];
    }

    async function downloadVideo() {
        if(frames.length === 0) return;
        isPlaying = false;
        document.getElementById('overlay-msg').innerText = "ğŸ“¹ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—ä¸­...";
        document.getElementById('overlay').style.display = 'flex';
        const currentFps = document.getElementById('fps').value;
        const stream = playCanvas.captureStream(currentFps);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'movie.webm'; a.click();
            document.getElementById('overlay').style.display = 'none';
        };
        recorder.start();
        playCanvas.style.display = "block";
        for(let i = 0; i < frames.length; i++) {
            await new Promise(resolve => {
                const img = new Image();
                img.onload = () => { pCtx.clearRect(0,0,640,480); pCtx.drawImage(img, 0, 0); setTimeout(resolve, 1000 / currentFps); };
                img.src = frames[i];
            });
        }
        recorder.stop();
        playCanvas.style.display = "none";
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') takePhoto(true); };
</script>
</body>
</html>
