<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆç·¨é›†æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #fafafa; margin: 0; padding-bottom: 50px; }
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f0f0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        #main-content { display: none; padding: 10px; }
        
        .layout { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        video, #edit-canvas, #canvas-preview { width: 400px; background: #000; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .editor-box { border: 2px solid #1e90ff; padding: 10px; border-radius: 10px; background: #eef7ff; }
        .controls { margin: 15px 0; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        button { padding: 8px 16px; font-size: 14px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        #shutter { background: #ff4757; color: white; }
        .btn-tool { background: #747d8c; color: white; }
        #save-frame { background: #1e90ff; color: white; font-size: 18px; }
        #play-btn { background: #2ed573; color: white; }
        #download-btn { background: #2f3542; color: white; }

        .frames { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 20px; border-top: 2px solid #ddd; padding: 10px; overflow-y: auto; max-height: 200px; background: white; }
        .frames img { width: 80px; border: 1px solid #ccc; }
        .tool-bar { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2>ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
        <input type="password" id="pass-input" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰">
        <button onclick="checkPass()">å…¥å®¤</button>
        <p id="error-msg" style="color: red;"></p>
    </div>

    <div id="main-content">
        <h1>ğŸ¬ ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ + ã‚‰ããŒã</h1>
        
        <div class="layout">
            <div>
                <p>1. ã‚«ãƒ¡ãƒ©</p>
                <video id="video" autoplay playsinline></video>
                <div class="controls">
                    <button id="shutter">ğŸ“¸ æ’®å½±ã—ã¦ç·¨é›†ã¸</button>
                </div>
            </div>

            <div class="editor-box">
                <p>2. ç·¨é›†ï¼ˆãƒšãƒ³ãƒ»æ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰</p>
                <div class="tool-bar">
                    è‰²:<input type="color" id="color-picker" value="#ff0000">
                    å¤ªã•:<input type="range" id="pen-size" min="1" max="20" value="5" style="width:60px">
                    <button class="btn-tool" onclick="setTool('pen')">âœï¸ãƒšãƒ³</button>
                    <button class="btn-tool" onclick="addText()">ğŸ”¤æ–‡å­—</button>
                    <button class="btn-tool" onclick="addStamp('â­')">â­</button>
                    <button class="btn-tool" onclick="addStamp('ğŸ”¥')">ğŸ”¥</button>
                    <button class="btn-tool" onclick="clearEdit()">âŒæ¶ˆå»</button>
                </div>
                <canvas id="edit-canvas"></canvas>
                <div class="controls">
                    <button id="save-frame">âœ… ã“ã®ã‚³ãƒã‚’ä¿å­˜</button>
                </div>
            </div>

            <div>
                <p>3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                <canvas id="canvas-preview"></canvas>
                <div class="controls">
                    <button id="play-btn">â–¶ï¸ å†ç”Ÿ</button>
                    <button id="download-btn">ğŸ’¾ å‹•ç”»ä¿å­˜</button>
                    é€Ÿåº¦:<input type="number" id="fps" value="10" min="1" max="30" style="width:40px">
                </div>
            </div>
        </div>

        <h3>ä¿å­˜ã•ã‚ŒãŸã‚³ãƒï¼ˆåˆè¨ˆ: <span id="count">0</span>æšï¼‰</h3>
        <button id="delete-btn">â†©ï¸ æœ€å¾Œã®1æšã‚’æ¶ˆã™</button>
        <div id="frames" class="frames"></div>
    </div>

    <script>
        const SECRET_PASSWORD = "QXJ0U3Rvc"; 
        let capturedFrames = [];
        let isDrawing = false;
        
        const video = document.getElementById('video');
        const editCanvas = document.getElementById('edit-canvas');
        const eCtx = editCanvas.getContext('2d');
        const previewCanvas = document.getElementById('canvas-preview');
        const pCtx = previewCanvas.getContext('2d');

        function checkPass() {
            if (document.getElementById('pass-input').value === SECRET_PASSWORD) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                startCamera();
            } else {
                document.getElementById('error-msg').innerText = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
            }
        }

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                editCanvas.width = previewCanvas.width = video.videoWidth;
                editCanvas.height = previewCanvas.height = video.videoHeight;
            };
        }

        // 1. æ’®å½±
        document.getElementById('shutter').onclick = () => {
            eCtx.drawImage(video, 0, 0, editCanvas.width, editCanvas.height);
        };

        // 2. ãŠçµµæã
        editCanvas.onmousedown = (e) => { isDrawing = true; eCtx.beginPath(); };
        editCanvas.onmousemove = (e) => {
            if (!isDrawing) return;
            const rect = editCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (editCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (editCanvas.height / rect.height);
            eCtx.lineWidth = document.getElementById('pen-size').value;
            eCtx.lineCap = 'round';
            eCtx.strokeStyle = document.getElementById('color-picker').value;
            eCtx.lineTo(x, y);
            eCtx.stroke();
        };
        window.onmouseup = () => isDrawing = false;

        // æ–‡å­—è¿½åŠ 
        function addText() {
            const text = prompt("å…¥ã‚ŒãŸã„æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (text) {
                eCtx.font = "bold 50px sans-serif";
                eCtx.fillStyle = document.getElementById('color-picker').value;
                eCtx.fillText(text, 50, 100);
            }
        }

        // ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
        function addStamp(emoji) {
            eCtx.font = "80px serif";
            eCtx.fillText(emoji, editCanvas.width/2 - 40, editCanvas.height/2 + 40);
        }

        // ç·¨é›†ã‚¯ãƒªã‚¢
        function clearEdit() {
            eCtx.drawImage(video, 0, 0, editCanvas.width, editCanvas.height);
        }

        // 3. ä¿å­˜
        document.getElementById('save-frame').onclick = () => {
            capturedFrames.push(editCanvas.toDataURL('image/png'));
            updateFrames();
            // ä¿å­˜ã—ãŸã‚‰æ¬¡ã®æ’®å½±ã®ãŸã‚ã«ç·¨é›†ç”»é¢ã‚’ã‚¯ãƒªã‚¢
            eCtx.clearRect(0,0,editCanvas.width, editCanvas.height);
        };

        function updateFrames() {
            const container = document.getElementById('frames');
            container.innerHTML = '';
            capturedFrames.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                container.appendChild(img);
            });
            document.getElementById('count').innerText = capturedFrames.length;
        }

        document.getElementById('delete-btn').onclick = () => {
            capturedFrames.pop();
            updateFrames();
        };

        // å†ç”Ÿãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯å‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆ
        document.getElementById('play-btn').onclick = () => {
            if (capturedFrames.length === 0) return;
            let i = 0;
            const interval = setInterval(() => {
                const img = new Image();
                img.src = capturedFrames[i];
                img.onload = () => pCtx.drawImage(img, 0, 0);
                i++;
                if (i >= capturedFrames.length) clearInterval(interval);
            }, 1000 / document.getElementById('fps').value);
        };

        document.getElementById('download-btn').onclick = () => {
            if (capturedFrames.length === 0) return;
            const stream = previewCanvas.captureStream(document.getElementById('fps').value);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob(chunks, { type: 'video/webm' }));
                a.download = 'koma-anime.webm';
                a.click();
            };
            recorder.start();
            let i = 0;
            const interval = setInterval(() => {
                const img = new Image();
                img.src = capturedFrames[i];
                img.onload = () => pCtx.drawImage(img, 0, 0);
                i++;
                if (i >= capturedFrames.length) { clearInterval(interval); recorder.stop(); }
            }, 1000 / document.getElementById('fps').value);
        };
    </script>
</body>
</html>
