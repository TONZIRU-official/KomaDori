<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>KOMADORI STUDIO</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #ff4757; --blue: #00a8ff; --green: #2ed573; --text: #eee; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .lock-card { background: var(--panel); padding: 40px; border-radius: 12px; border: 1px solid var(--blue); text-align: center; }
        input { background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 8px; }
        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; }
        .monitor-wrapper { position: relative; width: 640px; height: 480px; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; }
        video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        #onion-layer { opacity: 0.4; pointer-events: none; }
        .controls { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .btn { padding: 10px 16px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; color: white; }
        .gallery { height: 110px; background: #0a0a0a; display: flex; gap: 8px; padding: 10px; overflow-x: auto; border-top: 1px solid #222; }
        .gallery-item { height: 90px; border: 1px solid #444; position: relative; flex-shrink: 0; }
        .gallery-item img { height: 100%; border-radius: 4px; }
        .del-btn { position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-card">
        <h2>ğŸ”‘ PASSCODE</h2>
        <input type="password" id="pass-input" placeholder="****"><br><br>
        <button class="btn" style="background:var(--blue); width:100%" onclick="checkPass()">ENTER</button>
    </div>
</div>

<header>
    <span style="color:var(--blue); font-weight:bold;">ğŸ¬ KOMADORI WebM</span>
    <div style="display:flex; gap:8px;">
        <button class="btn" style="background:#444" onclick="switchCam()">ğŸ“· åˆ‡æ›¿</button>
        <button class="btn" style="background:var(--purple)" onclick="saveProject()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn" style="background:#4b6584" onclick="$('fileInput').click()">ğŸ“‚ èª­è¾¼</button>
        <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="loadProject(event)">
    </div>
    <div>ã‚³ãƒæ•°: <span id="count">0</span></div>
</header>

<div class="container">
    <div class="monitor-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="onion-layer"></canvas>
        <canvas id="play-canvas" style="display:none;"></canvas>
    </div>
    <div class="controls">
        <button class="btn" style="background:var(--accent); font-size:1.2rem;" onclick="takePhoto()">ğŸ“¸ æ’®å½± (Enter)</button>
        <button class="btn" style="background:var(--blue);" id="play-btn" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ (Space)</button>
        <button class="btn" style="background:#57606f;" onclick="deleteFrame(-1)">â†©ï¸ æˆ»ã‚‹ (Z)</button>
        <button class="btn" style="background:var(--green);" onclick="downloadWebM()">ğŸ“¹ å‹•ç”»å‡ºåŠ›</button>
        <button class="btn" style="background:#333;" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        <div style="font-size:12px;">FPS: <input type="number" id="fps" value="10" style="width:35px;"></div>
    </div>
</div>

<div class="gallery" id="gallery"></div>

<script>
    const PASS = "ArtStop", $ = id => document.getElementById(id);
    let frames = [], isPlaying = false, playIdx = 0, facing = "user";
    const v = $('video'), oC = $('onion-layer'), oCtx = oC.getContext('2d'), pC = $('play-canvas'), pCtx = pC.getContext('2d');

    async function startCamera() {
        if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing, width: 640, height: 480 } });
        v.srcObject = stream;
        oC.width = pC.width = 640; oC.height = pC.height = 480;
    }

    function checkPass() { if($('pass-input').value === PASS){ $('lock-screen').style.display='none'; startCamera(); } }
    function switchCam() { facing = (facing === "user") ? "environment" : "user"; startCamera(); }

    function takePhoto() {
        if(isPlaying) return;
        const c = document.createElement('canvas');
        c.width = 640; c.height = 480;
        c.getContext('2d').drawImage(v, 0, 0);
        frames.push(c.toDataURL('image/png'));
        updateUI();
    }

    function deleteFrame(idx) {
        if(idx === -1) frames.pop();
        else if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) frames.splice(idx, 1);
        updateUI();
    }

    function updateUI() {
        $('count').innerText = frames.length;
        $('gallery').innerHTML = frames.map((src, i) => `
            <div class="gallery-item" onclick="updateOnion('${src}')">
                <img src="${src}"><span>${i+1}</span>
                <div class="del-btn" onclick="event.stopPropagation(); deleteFrame(${i})">Ã—</div>
            </div>`).join('');
        $('gallery').scrollLeft = $('gallery').scrollWidth;
        updateOnion(frames[frames.length - 1] || null);
    }

    function updateOnion(src) {
        oCtx.clearRect(0, 0, 640, 480);
        if(!src) return;
        const img = new Image(); img.onload = () => oCtx.drawImage(img, 0, 0); img.src = src;
    }

    function togglePlay() {
        if (!frames.length) return;
        isPlaying = !isPlaying;
        $('play-btn').innerText = isPlaying ? "â¹ï¸ åœæ­¢" : "â¯ï¸ å†ç”Ÿ";
        pC.style.display = isPlaying ? "block" : "none";
        if (isPlaying) { playIdx = 0; playLoop(); }
    }

    function playLoop() {
        if (!isPlaying) return;
        const img = new Image();
        img.onload = () => {
            pCtx.drawImage(img, 0, 0);
            playIdx = (playIdx + 1) % frames.length;
            setTimeout(playLoop, 1000 / $('fps').value);
        };
        img.src = frames[playIdx];
    }

    // WebMã®éŒ²ç”»ä¿å­˜æ©Ÿèƒ½
    async function downloadWebM() {
        if (!frames.length) return;
        pC.style.display = "block";
        const stream = pC.captureStream($('fps').value);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'animation.webm'; a.click();
            pC.style.display = "none";
        };

        recorder.start();
        for (let i = 0; i < frames.length; i++) {
            await new Promise(res => {
                const img = new Image();
                img.onload = () => {
                    pCtx.drawImage(img, 0, 0);
                    setTimeout(res, 1000 / $('fps').value);
                };
                img.src = frames[i];
            });
        }
        recorder.stop();
    }

    function saveProject() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify({fps: $('fps').value, frames})], {type:'application/json'}));
        a.download = 'project.json'; a.click();
    }

    function loadProject(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            frames = data.frames; $('fps').value = data.fps; updateUI();
        };
        reader.readAsText(e.target.files[0]);
    }

    function resetAll() { if(confirm("ãƒªã‚»ãƒƒãƒˆï¼Ÿ")) { frames = []; updateUI(); } }

    window.onkeydown = (e) => {
        if($('lock-screen').style.display === 'none') {
            if(e.key === 'Enter') takePhoto();
            if(e.key === ' ') { e.preventDefault(); togglePlay(); }
            if(e.key.toLowerCase() === 'z') deleteFrame(-1);
            if(e.key.toLowerCase() === 's') saveProject();
        }
    };
</script>
</body>
</html>
