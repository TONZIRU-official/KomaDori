<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šå°‚ç”¨ã‚«ãƒ¡ãƒ©</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ç”»é¢ */
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .lock-box { background: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; text-align: center; }
        input[type="password"] { font-size: 20px; padding: 10px; border-radius: 5px; border: none; margin-bottom: 20px; text-align: center; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        header { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 20px; }
        
        /* ã‚«ãƒ¡ãƒ©ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .monitor { position: relative; width: 640px; height: 480px; background: #000; border: 4px solid #333; border-radius: 8px; overflow: hidden; }
        canvas, video { position: absolute; top: 0; left: 0; width: 640px; height: 480px; }
        #onion-layer { opacity: 0.4; pointer-events: none; } /* å‰ã®å†™çœŸã‚’é€ã‹ã™ãƒ¬ã‚¤ãƒ¤ãƒ¼ */

        /* æ’®ã£ãŸå†™çœŸãŒä¸¦ã¶ã‚¨ãƒªã‚¢ï¼ˆç·¨é›†ãƒ¬ãƒ¼ãƒ«ã§ã¯ãªãã€ç¢ºèªç”¨ã®å†™çœŸç½®ãå ´ï¼‰ */
        .gallery { height: 120px; background: #111; display: flex; gap: 5px; padding: 10px; overflow-x: auto; border-top: 1px solid #333; }
        .gallery img { height: 100px; border: 1px solid #444; border-radius: 4px; }

        /* ãƒœã‚¿ãƒ³ */
        .controls { display: flex; gap: 20px; margin-top: 20px; align-items: center; }
        .btn { padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-shoot { background: #ff4757; color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
        .btn-shoot:active { transform: scale(0.95); }
        .btn-play { background: #2ed573; color: white; }
        .btn-clear { background: #57606f; color: white; font-size: 12px; padding: 10px 20px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2>ğŸ”‘ PASSCODE</h2>
        <input type="password" id="pass-input" placeholder="****">
        <br>
        <button class="btn btn-play" onclick="checkPass()">ENTER</button>
    </div>
</div>

<header>
    <div style="font-weight: bold; letter-spacing: 2px;">STOPMOTION CAMERA</div>
    <div>æšæ•°: <span id="count">0</span>æš</div>
</header>

<div class="main">
    <div class="monitor">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="onion-layer"></canvas>
        <canvas id="play-canvas" style="display:none;"></canvas> </div>

    <div class="controls">
        <button class="btn btn-shoot" onclick="takePhoto()">ğŸ“¸ æ’®å½± (Enter)</button>
        <button class="btn btn-play" id="play-btn" onclick="togglePlay()">â¯ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ</button>
        <button class="btn btn-clear" onclick="clearPhotos()">å…¨å‰Šé™¤</button>
        <div style="font-size: 12px;">å†ç”Ÿé€Ÿåº¦: <input type="number" id="fps" value="10" style="width:40px; background: #000; color: white; border: 1px solid #444;"> fps</div>
    </div>
</div>

<div class="gallery" id="gallery">
    </div>

<script>
    const PASS = "ArtStop";
    let frames = [];
    let isPlaying = false;
    let playIdx = 0;

    const video = document.getElementById('video');
    const onionCanvas = document.getElementById('onion-layer');
    const oCtx = onionCanvas.getContext('2d');
    const playCanvas = document.getElementById('play-canvas');
    const pCtx = playCanvas.getContext('2d');

    function checkPass() {
        if(document.getElementById('pass-input').value === PASS) {
            document.getElementById('lock-screen').style.display = 'none';
            startCamera();
        }
    }

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({video: {width: 640, height: 480}});
        video.srcObject = stream;
        onionCanvas.width = playCanvas.width = 640;
        onionCanvas.height = playCanvas.height = 480;
    }

    // æ’®å½±ï¼šå†™çœŸã‚’æ’®ã£ã¦ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ã«ã™ã‚‹
    function takePhoto() {
        if(isPlaying) return;

        const c = document.createElement('canvas');
        c.width = 640; c.height = 480;
        c.getContext('2d').drawImage(video, 0, 0);
        const data = c.toDataURL('image/png');
        
        frames.push(data);
        updateUI();

        // ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ï¼ˆä»Šã®å†™çœŸã‚’é€ã‹ã—ã¦è¡¨ç¤ºï¼‰
        const img = new Image();
        img.onload = () => {
            oCtx.clearRect(0,0,640,480);
            oCtx.drawImage(img, 0, 0);
        };
        img.src = data;
    }

    function updateUI() {
        document.getElementById('count').innerText = frames.length;
        const gal = document.getElementById('gallery');
        gal.innerHTML = '';
        frames.slice().reverse().forEach(src => { // æ–°ã—ã„é †ã«ä¸¦ã¹ã‚‹
            const img = document.createElement('img');
            img.src = src;
            gal.appendChild(img);
        });
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ
    function togglePlay() {
        isPlaying = !isPlaying;
        const btn = document.getElementById('play-btn');
        if(isPlaying) {
            btn.innerText = "â¹ï¸ åœæ­¢";
            playCanvas.style.display = "block";
            playLoop();
        } else {
            btn.innerText = "â¯ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ";
            playCanvas.style.display = "none";
        }
    }

    function playLoop() {
        if(!isPlaying || frames.length === 0) return;
        
        const img = new Image();
        img.onload = () => {
            pCtx.clearRect(0,0,640,480);
            pCtx.drawImage(img, 0, 0);
            playIdx = (playIdx + 1) % frames.length;
            setTimeout(playLoop, 1000 / document.getElementById('fps').value);
        };
        img.src = frames[playIdx];
    }

    function clearPhotos() {
        if(confirm("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            frames = [];
            oCtx.clearRect(0,0,640,480);
            updateUI();
        }
    }

    window.onkeydown = (e) => { if(e.key === 'Enter') takePhoto(); };
</script>
</body>
</html>
