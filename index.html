<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚³ãƒæ’®ã‚Šãƒ¡ãƒ¼ã‚«ãƒ¼ Ultra Pro (Locked)</title>
    <style>
        :root { --primary: #00a8ff; --accent: #e84118; --dark: #1e2124; --panel: #2f3640; --track: #353b48; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--dark); color: white; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯ç”»é¢ */
        #lock-screen {
            position: fixed; inset: 0; background: #111; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lock-box { background: #222; padding: 40px; border-radius: 15px; border: 2px solid var(--primary); text-align: center; }
        #pass-input { font-size: 24px; padding: 10px; width: 200px; margin: 20px 0; border-radius: 5px; border: none; text-align: center; }

        /* ãƒ¡ã‚¤ãƒ³UIï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ */
        #app-container { display: none; flex-direction: column; height: 100vh; }
        
        header { background: #111; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .preview-section { flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        .properties-panel { flex: 1.2; background: var(--panel); padding: 15px; overflow-y: auto; border-left: 2px solid #000; font-size: 13px; }
        
        .canvas-wrapper { position: relative; background: #000; line-height: 0; }
        canvas, video { max-width: 100%; max-height: 60vh; object-fit: contain; }

        .timeline-container { height: 240px; background: #111; border-top: 3px solid #000; display: flex; flex-direction: column; }
        .timeline-scroll { flex: 1; overflow-x: auto; overflow-y: auto; position: relative; padding: 10px 0; }
        .timeline-row { height: 35px; background: var(--track); margin: 4px 0; position: relative; min-width: 5000px; border-radius: 2px; }
        .item-block { position: absolute; height: 25px; top: 5px; background: var(--primary); border: 1px solid #fff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; padding: 0 8px; font-size: 11px; white-space: nowrap; overflow: hidden; }
        .playhead { position: absolute; top: 0; width: 2px; height: 100%; background: #fbc531; z-index: 100; pointer-events: none; }

        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-capture { background: var(--accent); color: white; }
        .btn-tool { background: #444; color: white; margin: 2px; }
        .flex-row { display: flex; gap: 5px; margin-top: 5px; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2 style="margin:0;">ğŸ”‘ ã‚³ãƒæ’®ã‚Š Ultra Pro</h2>
        <p style="color:#aaa;">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="pass-input" placeholder="****">
        <br>
        <button class="btn btn-tool" style="width:100%; font-size:16px;" onclick="checkPass()">å…¥å®¤</button>
        <p id="error-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<div id="app-container">
    <header>
        <div style="font-weight: bold; color: var(--primary);">ğŸ¬ STOPMOTION ULTRA PRO</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-tool" onclick="setMode('shoot')" id="tab-shoot">ğŸ“· æ’®å½±</button>
            <button class="btn btn-tool" onclick="setMode('edit')" id="tab-edit">âœ‚ï¸ ç·¨é›†</button>
            <button class="btn btn-capture" onclick="exportVideo()">ğŸ’¾ å®Œæˆä¿å­˜</button>
        </div>
    </header>

    <div class="main-layout">
        <section class="preview-section">
            <div class="canvas-wrapper">
                <video id="video" autoplay playsinline></video>
                <canvas id="onion-layer" style="position:absolute; top:0; left:0; opacity:0.4; pointer-events:none;"></canvas>
                <canvas id="main-canvas"></canvas>
            </div>
            <div style="padding:15px; display:flex; gap:10px; align-items:center;">
                <button class="btn btn-capture" id="shutter-btn" onclick="takePhoto()">ğŸ“¸ æ’®å½± (Enter)</button>
                <button class="btn btn-tool" onclick="togglePlay()">â¯ï¸ å†ç”Ÿ/åœæ­¢</button>
                <div style="font-size:12px;">ã‚¹ãƒ”ãƒ¼ãƒ‰: <input type="number" id="fps-input" value="10" style="width:40px; background:#111; color:white; border:1px solid #555;" oninput="fps=this.value"> fps</div>
                <div style="font-size:12px;">Frames: <span id="frame-count">0</span></div>
            </div>
        </section>

        <aside class="properties-panel">
            <div id="no-selection">ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div id="editor-ui" style="display:none;">
                <div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                    <h3 style="font-size:12px; color:var(--primary);">ãƒ†ã‚­ã‚¹ãƒˆ / ã‚¹ã‚¿ãƒ³ãƒ—</h3>
                    <input type="text" id="prop-text" oninput="updateItem()" style="background:#111; color:white; border:1px solid #555; width:100%; padding:4px;">
                    <div class="flex-row">
                        <button class="btn btn-tool" onclick="addShape('â­')">â­</button>
                        <button class="btn btn-tool" onclick="addShape('ğŸ’¬')">ğŸ’¬</button>
                        <button class="btn btn-tool" onclick="addShape('â¤ï¸')">â¤ï¸</button>
                        <button class="btn btn-tool" onclick="addShape('ğŸ’¥')">ğŸ’¥</button>
                    </div>
                </div>
                <div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                    <h3 style="font-size:12px; color:var(--primary);">ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š</h3>
                    è‰²: <input type="color" id="prop-color" oninput="updateItem()"><br>
                    ç¸: <input type="color" id="prop-stroke" oninput="updateItem()" value="#000000"><br>
                    ä¸é€æ˜åº¦: <input type="range" id="prop-alpha" min="0" max="100" value="100" oninput="updateItem()"><br>
                    ã‚µã‚¤ã‚º: <input type="range" id="prop-size" min="10" max="200" oninput="updateItem()">
                </div>
                <div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                    <h3 style="font-size:12px; color:var(--primary);">ä½ç½®ã¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</h3>
                    X: <input type="range" id="prop-x" min="0" max="640" oninput="updateItem()">
                    Y: <input type="range" id="prop-y" min="0" max="480" oninput="updateItem()">
                    <label style="display:block; margin-top:5px;"><input type="checkbox" id="prop-fade" onchange="updateItem()"> ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæœ‰åŠ¹</label>
                </div>
                <button class="btn btn-capture" style="width:100%" onclick="deleteItem()">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
            <button class="btn btn-tool" style="width:100%; margin-top:10px; border:1px dashed #666;" onclick="addItem()">â• å­—å¹•ãƒ»ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </button>
        </aside>
    </div>

    <div class="timeline-container">
        <div class="timeline-scroll" id="tl-scroll" onclick="seek(event)">
            <div class="playhead" id="playhead"></div>
            <div class="timeline-row" id="track-1"></div>
        </div>
    </div>
</div>

<script>
    const SECRET_PASSWORD = "QXJ0U3Rvc"; // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
    let frames = [], items = [], mode = 'shoot', curTime = 0, isPlaying = false, selectedId = null, fps = 10;
    const pxPerSec = 80;

    const video = document.getElementById('video');
    const mainCanvas = document.getElementById('main-canvas');
    const mCtx = mainCanvas.getContext('2d');
    const onionCanvas = document.getElementById('onion-layer');
    const oCtx = onionCanvas.getContext('2d');

    // ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    function checkPass() {
        const input = document.getElementById('pass-input').value;
        if (input === SECRET_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            initApp();
        } else {
            document.getElementById('error-msg').innerText = "ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“";
        }
    }

    function initApp() {
        navigator.mediaDevices.getUserMedia({video: {width:640, height:480}}).then(s => {
            video.srcObject = s;
            video.onloadedmetadata = () => {
                mainCanvas.width = onionCanvas.width = video.videoWidth;
                mainCanvas.height = onionCanvas.height = video.videoHeight;
            };
        });
    }

    function setMode(m) {
        mode = m;
        video.style.display = m==='shoot' ? 'block' : 'none';
        onionCanvas.style.display = m==='shoot' ? 'block' : 'none';
        if(m==='edit') draw();
    }

    function takePhoto() {
        const c = document.createElement('canvas');
        c.width = 640; c.height = 480;
        c.getContext('2d').drawImage(video, 0, 0);
        frames.push(c.toDataURL('image/png'));
        document.getElementById('frame-count').innerText = frames.length;
        const img = new Image(); img.src = frames[frames.length-1];
        img.onload = () => { oCtx.clearRect(0,0,640,480); oCtx.drawImage(img, 0, 0); };
    }

    function addItem() {
        const id = Date.now();
        items.push({ id, text: "ãƒ†ã‚­ã‚¹ãƒˆ", start: curTime, end: curTime+2, x: 320, y: 400, color: "#ffffff", stroke: "#000000", size: 40, alpha: 1, fade: false });
        renderTimeline(); selectItem(id); setMode('edit');
    }

    function addShape(emoji) {
        if(!selectedId) addItem();
        const item = items.find(i => i.id === selectedId);
        item.text = emoji; item.size = 80; updateItem();
    }

    function renderTimeline() {
        document.getElementById('track-1').innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-block';
            div.innerText = item.text;
            div.style.left = (item.start * pxPerSec) + 'px';
            div.style.width = ((item.end - item.start) * pxPerSec) + 'px';
            div.onclick = (e) => { e.stopPropagation(); selectItem(item.id); };
            document.getElementById('track-1').appendChild(div);
        });
    }

    function selectItem(id) {
        selectedId = id; const item = items.find(i => i.id === id);
        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('editor-ui').style.display = 'block';
        document.getElementById('prop-text').value = item.text;
        document.getElementById('prop-color').value = item.color;
        document.getElementById('prop-size').value = item.size;
        document.getElementById('prop-x').value = item.x;
        document.getElementById('prop-y').value = item.y;
        document.getElementById('prop-alpha').value = item.alpha * 100;
        document.getElementById('prop-fade').checked = item.fade;
    }

    function updateItem() {
        const item = items.find(i => i.id === selectedId); if(!item) return;
        item.text = document.getElementById('prop-text').value;
        item.color = document.getElementById('prop-color').value;
        item.stroke = document.getElementById('prop-stroke').value;
        item.size = parseInt(document.getElementById('prop-size').value);
        item.x = parseInt(document.getElementById('prop-x').value);
        item.y = parseInt(document.getElementById('prop-y').value);
        item.alpha = document.getElementById('prop-alpha').value / 100;
        item.fade = document.getElementById('prop-fade').checked;
        renderTimeline(); draw();
    }

    function draw() {
        if(frames.length === 0) return;
        const idx = Math.min(Math.floor(curTime * fps), frames.length - 1);
        const img = new Image(); img.src = frames[idx];
        img.onload = () => {
            mCtx.clearRect(0,0,640,480); mCtx.drawImage(img, 0, 0);
            items.forEach(item => {
                if(curTime >= item.start && curTime <= item.end) {
                    let a = item.alpha;
                    if(item.fade && (item.end - curTime < 0.5)) a *= ((item.end - curTime) / 0.5);
                    mCtx.globalAlpha = a;
                    mCtx.font = `bold ${item.size}px sans-serif`;
                    mCtx.textAlign = "center"; mCtx.lineJoin = "round";
                    mCtx.lineWidth = item.size / 6; mCtx.strokeStyle = item.stroke;
                    mCtx.strokeText(item.text, item.x, item.y);
                    mCtx.fillStyle = item.color; mCtx.fillText(item.text, item.x, item.y);
                    mCtx.globalAlpha = 1;
                }
            });
        };
    }

    function seek(e) {
        const rect = document.getElementById('tl-scroll').getBoundingClientRect();
        curTime = (e.clientX - rect.left + document.getElementById('tl-scroll').scrollLeft) / pxPerSec;
        document.getElementById('playhead').style.left = (curTime * pxPerSec) + 'px';
        draw();
    }

    function togglePlay() { isPlaying = !isPlaying; if(isPlaying) loop(); }
    function loop() {
        if(!isPlaying) return;
        curTime += 1/fps;
        if(curTime > frames.length/fps) curTime = 0;
        document.getElementById('playhead').style.left = (curTime * pxPerSec) + 'px';
        draw(); setTimeout(loop, 1000/fps);
    }

    function deleteItem() { items = items.filter(i => i.id !== selectedId); document.getElementById('editor-ui').style.display = 'none'; renderTimeline(); draw(); }
    window.onkeydown = e => { if(e.key === 'Enter' && mode === 'shoot') takePhoto(); };

    async function exportVideo() {
        const stream = mainCanvas.captureStream(fps);
        const rec = new MediaRecorder(stream, {mimeType:'video/webm'});
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(chunks, {type:'video/webm'}));
            a.download = 'stopmotion-pro.webm'; a.click();
        };
        rec.start(); isPlaying = false;
        for(let i=0; i<frames.length; i++) { curTime = i/fps; draw(); await new Promise(r => setTimeout(r, 100)); }
        rec.stop();
    }
</script>
</body>
</html>
